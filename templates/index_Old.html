<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å…ƒé‚®èƒ¶å›Š</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:å¾®è½¯é›…é»‘,PingFang SC,sans-serif;}
body{margin:0;height:100vh;position:relative;display:flex;flex-direction:column;overflow:hidden;}
.bg{position:fixed;width:100%;height:100%;background:url(/static/bg.jpg) center/cover;opacity:0.65;filter:blur(2px);z-index:1;}
.btn-group{position:absolute;top:15px;right:15px;z-index:10;display:flex;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,40,120,0.15);}
.btn{width:82px;height:82px;background:rgba(255,255,255,0.98);display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;transition:all 0.3s ease;}
.btn:last-child{border-left:1px solid #f5f9ff;}
.btn:hover{background:#fff;transform:translateY(-3px);box-shadow:0 0 12px rgba(22,119,255,0.2);}
.icon{font-size:34px;color:#2366d1;margin-bottom:4px;transition:all 0.3s;}
.icon-text{font-size:15px;color:#2366d1;font-weight:600;letter-spacing:1px;transition:all 0.3s;}
.btn:hover .icon{color:#165dff;transform:scale(1.08);}
.btn:hover .icon-text{color:#165dff;font-weight:700;}
.title{text-align:center;margin:30px auto 0;z-index:10;position:relative;}
.main-title{font-size:62px;color:#1f56b3;padding:20px 52px;border:3px solid #4a90e2;border-radius:16px;background:rgba(255,255,255,0.95);display:inline-block;letter-spacing:5px;box-shadow:0 6px 20px rgba(74,144,226,0.2);}
.middle-box{flex:1;display:flex;z-index:10;padding:0 20px;gap:12px;margin:20px 0;}
.middle-btn{width:50%;display:flex;justify-content:center;align-items:center;border-radius:20px;box-shadow:0 8px 25px rgba(0,40,120,0.08);font-size:36px;font-weight:700;cursor:pointer;transition:all 0.4s ease;text-decoration:none;}
.left-btn{background:linear-gradient(135deg,rgba(230,240,255,0.95),rgba(209,224,255,0.95));color:#1f56b3;}
.right-btn{background:linear-gradient(135deg,rgba(209,224,255,0.95),rgba(158,183,255,0.95));color:#144294;}
.middle-btn:hover{transform:translateY(-5px);box-shadow:0 12px 30px rgba(74,144,226,0.2);}
.footer-box{height:80px;z-index:10;display:flex;padding:0 30px;gap:12px;align-items:center;justify-content:center;margin-bottom:15px;}
.footer-btn{width:45%;height:50px;background:rgba(255,255,255,0.9);border-radius:12px;display:flex;justify-content:center;align-items:center;font-size:18px;color:#2366d1;font-weight:500;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 10px rgba(0,40,120,0.05);}
.footer-btn:hover{background:#fff;transform:translateY(-2px);color:#165dff;box-shadow:0 4px 15px rgba(22,119,255,0.1);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:99;}
.modal-box{width:380px;background:#fff;padding:30px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.15);}
.close-btn{float:right;cursor:pointer;color:#999;font-size:20px;transition:all 0.2s;}
.close-btn:hover{color:#333;}
.modal-title{font-size:22px;color:#1f56b3;margin-bottom:20px;text-align:center;font-weight:600;padding-bottom:15px;border-bottom:1px solid #f0f5ff;}
.modal-txt{font-size:16px;color:#555;line-height:1.6;}
.form-item{margin:12px 0;}
.form-item label{display:block;font-size:14px;color:#666;margin-bottom:6px;}
.form-item input{width:100%;height:40px;padding:0 12px;border:1px solid #e0e8f5;border-radius:8px;font-size:15px;transition:all 0.2s;}
.form-item input:focus{outline:none;border-color:#4a90e2;box-shadow:0 0 0 3px rgba(74,144,226,0.1);}
.submit-btn{width:100%;height:42px;background:#1f56b3;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:500;cursor:pointer;margin-top:8px;transition:all 0.3s;}
.submit-btn:hover{background:#165dff;}
.reg-txt{text-align:center;margin-top:15px;font-size:14px;color:#666;}
.reg-btn{color:#165dff;cursor:pointer;margin-left:5px;}
.reg-btn:hover{text-decoration:underline;}
.profile-header{text-align:center;margin-bottom:25px;}
.profile-avatar{width:80px;height:80px;border-radius:50%;margin:0 auto 10px;display:flex;justify-content:center;align-items:center;font-size:40px;background:#f0f7ff;object-fit:cover;}
.profile-info{margin:15px 0;font-size:16px;color:#333;display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f5f9ff;}
.info-label{color:#666;}
.edit-btn{font-size:14px;color:#165dff;cursor:pointer;}
.edit-btn:hover{text-decoration:underline;}
.gender-select{width:100%;height:40px;padding:0 12px;border:1px solid #e0e8f5;border-radius:8px;font-size:15px;color:#333;}
.college-select{width:100%;height:40px;padding:0 12px;border:1px solid #e0e8f5;border-radius:8px;font-size:15px;color:#333;}
.avatar-upload{margin-top:10px;}
.upload-btn{font-size:14px;color:#165dff;cursor:pointer;text-decoration:underline;}
#avatarInput{display:none;}
</style>
</head>
<body>
<div class="bg"></div>
<div class="btn-group">
  <div class="btn" onclick="document.getElementById('m1').style.display='flex'">
    <div class="icon">âœ‰ï¸</div>
    <div class="icon-text">é‚®ç®±</div>
  </div>
  <div class="btn" onclick="document.getElementById('m2').style.display='flex'">
    <div class="icon">ğŸ‘¤</div>
    <div class="icon-text">ç™»å½•</div>
  </div>
</div>
<div class="title">
  <h1 class="main-title">å…ƒé‚®èƒ¶å›Š</h1>
</div>
<div class="middle-box">
  <a href="{{ url_for('campus') }}" class="middle-btn left-btn">Explore</a>
  <div class="middle-btn right-btn">My BUPT</div>
</div>
<div class="footer-box">
  <div class="footer-btn" onclick="checkLoginThenShowProfile()">ä¸ªäººèµ„æ–™</div>
  <div class="footer-btn">å…³äºæˆ‘ä»¬</div>
</div>

<!-- æ¶ˆæ¯å¼¹çª— -->
<div class="modal" id="m1" onclick="this.style.display='none'">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="document.getElementById('m1').style.display='none'">Ã—</span>
    <h3 class="modal-title">æˆ‘çš„æ¶ˆæ¯</h3>
    <div class="modal-txt">æ¬¢è¿æ¥åˆ°å…ƒé‚®èƒ¶å›Š</div>
  </div>
</div>

<!-- ç™»å½•å¼¹çª— -->
<div class="modal" id="m2" onclick="this.style.display='none'">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="document.getElementById('m2').style.display='none'">Ã—</span>
    <h3 class="modal-title">è´¦å·ç™»å½•</h3>
    <div class="form-item">
      <label>ç”¨æˆ·åæˆ–å­¦å·</label>
      <input type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–å­¦å·" id="loginUsername">
    </div>
    <div class="form-item">
      <label>å¯†ç </label>
      <input type="password" placeholder="è¯·è¾“å…¥å¯†ç " id="loginPassword">
    </div>
    <button class="submit-btn" onclick="saveLoginInfo()">ç™»å½•</button>
    <div class="reg-txt">æœªæ³¨å†Œï¼Ÿ<span class="reg-btn" onclick="document.getElementById('m2').style.display='none';document.getElementById('m3').style.display='flex'">ç«‹å³æ³¨å†Œ</span></div>
  </div>
</div>

<!-- æ³¨å†Œå¼¹çª— -->
<div class="modal" id="m3" onclick="this.style.display='none'">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="document.getElementById('m3').style.display='none'">Ã—</span>
    <h3 class="modal-title">è´¦å·æ³¨å†Œ</h3>
    <div class="form-item">
      <label>ç”¨æˆ·å</label>
      <input type="text" placeholder="è¯·è®¾ç½®ç”¨æˆ·åï¼ˆè‡³å°‘3ä½ï¼‰" id="regUsername">
    </div>
    <div class="form-item">
      <label>å¯†ç </label>
      <input type="password" placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" id="regPassword">
    </div>
    <div class="form-item">
      <label>å­¦å·</label>
      <input type="text" placeholder="è¯·è¾“å…¥å­¦å·" id="regStudentId">
    </div>
    <button class="submit-btn" onclick="saveRegInfo()">å®Œæˆæ³¨å†Œ</button>
  </div>
</div>

<!-- ä¸ªäººèµ„æ–™æŸ¥çœ‹å¼¹çª— -->
<div class="modal" id="m4" onclick="this.style.display='none'">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="document.getElementById('m4').style.display='none'">Ã—</span>
    <h3 class="modal-title">ä¸ªäººèµ„æ–™</h3>
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar">ğŸ‘¨</div>
    </div>
    <div class="profile-info">
      <span class="info-label">ç”¨æˆ·å</span>
      <span id="showUsername">æœªç™»å½•</span>
    </div>
    <div class="profile-info">
      <span class="info-label">æ˜µç§°</span>
      <span id="showNickname">æœªè®¾ç½®</span>
    </div>
    <div class="profile-info">
      <span class="info-label">å­¦å·</span>
      <span id="showStudentId">æœªè®¾ç½®</span>
    </div>
    <div class="profile-info">
      <span class="info-label">æ€§åˆ«</span>
      <span id="showGender">æœªè®¾ç½®</span>
    </div>
    <div class="profile-info">
      <span class="info-label">å­¦é™¢</span>
      <span id="showCollege">æœªè®¾ç½®</span>
    </div>
    <div style="text-align:right;margin-top:20px;">
      <span class="edit-btn" onclick="document.getElementById('m4').style.display='none';document.getElementById('m5').style.display='flex'">ç¼–è¾‘èµ„æ–™</span>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
<div class="modal" id="m5" onclick="this.style.display='none'">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="document.getElementById('m5').style.display='none'">Ã—</span>
    <h3 class="modal-title">ç¼–è¾‘èµ„æ–™</h3>
    <div class="profile-header">
      <div class="profile-avatar" id="editAvatar">ğŸ‘¨</div>
      <div class="avatar-upload">
        <span class="upload-btn" onclick="document.getElementById('avatarInput').click()">é€‰æ‹©æœ¬åœ°å¤´åƒ</span>
        <input type="file" id="avatarInput" accept="image/*" onchange="previewAvatar(this)">
      </div>
    </div>
    <div class="form-item">
      <label>æ˜µç§°</label>
      <input type="text" placeholder="è¯·è¾“å…¥æ˜µç§°" id="editNickname">
    </div>
    <div class="form-item">
      <label>æ€§åˆ«</label>
      <select class="gender-select" id="editGender">
        <option value="æœªè®¾ç½®">è¯·é€‰æ‹©æ€§åˆ«</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
      </select>
    </div>
    <div class="form-item">
      <label>å­¦é™¢</label>
      <select class="college-select" id="editCollege">
        <option value="æœªè®¾ç½®">è¯·é€‰æ‹©å­¦é™¢</option>
        <option value="æ•°å­—åª’ä½“ä¸è‰ºæœ¯è®¾è®¡å­¦é™¢">æ•°å­—åª’ä½“ä¸è‰ºæœ¯è®¾è®¡å­¦é™¢</option>
        <option value="ä¿¡æ¯ä¸é€šä¿¡å·¥ç¨‹å­¦é™¢">ä¿¡æ¯ä¸é€šä¿¡å·¥ç¨‹å­¦é™¢</option>
        <option value="ç”µå­å·¥ç¨‹å­¦é™¢">ç”µå­å·¥ç¨‹å­¦é™¢</option>
        <option value="è®¡ç®—æœºå­¦é™¢">è®¡ç®—æœºå­¦é™¢</option>
        <option value="ç½‘ç»œç©ºé—´å®‰å…¨å­¦é™¢">ç½‘ç»œç©ºé—´å®‰å…¨å­¦é™¢</option>
        <option value="æ™ºèƒ½å·¥ç¨‹ä¸è‡ªåŠ¨åŒ–å­¦é™¢">æ™ºèƒ½å·¥ç¨‹ä¸è‡ªåŠ¨åŒ–å­¦é™¢</option>
      </select>
    </div>
    <button class="submit-btn" onclick="saveProfile()">ä¿å­˜ä¿®æ”¹</button>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentUser = null;
let avatarFile = null;

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
window.onload = function() {
    checkLoginStatus();
};

// æ£€æŸ¥ç™»å½•çŠ¶æ€
async function checkLoginStatus() {
    try {
        const response = await fetch('/api/check-login');
        const data = await response.json();

        if (data.logged_in && data.user) {
            currentUser = data.user;
            // å¦‚æœæœ‰ç”¨æˆ·ç™»å½•ï¼Œå¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›åˆå§‹åŒ–æ“ä½œ
            console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.username);
        }
    } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
    }
}

// æ ¸å¿ƒï¼šç‚¹ä¸ªäººèµ„æ–™å…ˆæŸ¥ç™»å½•ï¼Œæœªç™»å½•å¼¹ç™»å½•æ¡†
async function checkLoginThenShowProfile() {
    try {
        const response = await fetch('/api/check-login');
        const data = await response.json();

        if (data.logged_in && data.user) {
            currentUser = data.user;
            fillProfile();
            document.getElementById('m4').style.display = 'flex';
        } else {
            alert('è¯·å…ˆç™»å½•ï¼Œå†æŸ¥çœ‹ä¸ªäººèµ„æ–™ï½');
            document.getElementById('m2').style.display = 'flex';
        }
    } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        alert('è¯·å…ˆç™»å½•ï¼Œå†æŸ¥çœ‹ä¸ªäººèµ„æ–™ï½');
        document.getElementById('m2').style.display = 'flex';
    }
}

// ç™»å½•éªŒè¯
async function saveLoginInfo() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!username || !password) {
        alert('ç”¨æˆ·å/å­¦å·å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = document.querySelector('#m2 .submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'ç™»å½•ä¸­...';
        submitBtn.disabled = true;

        const response = await fetch('/api/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        });

        const data = await response.json();

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;

        if (data.success) {
            alert('ç™»å½•æˆåŠŸï¼');
            currentUser = data.user;
            document.getElementById('m2').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        } else {
            alert(data.message || 'ç™»å½•å¤±è´¥ï¼');
        }
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = document.querySelector('#m2 .submit-btn');
        submitBtn.textContent = 'ç™»å½•';
        submitBtn.disabled = false;
    }
}

// æ³¨å†Œ
async function saveRegInfo() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const studentId = document.getElementById('regStudentId').value.trim();

    if (!username || !password || !studentId) {
        alert('ç”¨æˆ·åã€å¯†ç ã€å­¦å·ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    if (username.length < 3) {
        alert('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦ï¼');
        return;
    }

    if (password.length < 6) {
        alert('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦ï¼');
        return;
    }

    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = document.querySelector('#m3 .submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'æ³¨å†Œä¸­...';
        submitBtn.disabled = true;

        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password,
                student_id: studentId
            })
        });

        const data = await response.json();

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;

        if (data.success) {
            alert('æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•ï½');
            currentUser = data.user;
            document.getElementById('m3').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regStudentId').value = '';
        } else {
            alert(data.message || 'æ³¨å†Œå¤±è´¥ï¼');
        }
    } catch (error) {
        console.error('æ³¨å†Œé”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = document.querySelector('#m3 .submit-btn');
        submitBtn.textContent = 'å®Œæˆæ³¨å†Œ';
        submitBtn.disabled = false;
    }
}

// å¤´åƒé¢„è§ˆ
function previewAvatar(input) {
    const file = input.files[0];
    if (file) {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶2MBï¼‰
        if (file.size > 2 * 1024 * 1024) {
            alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MBï¼');
            input.value = '';
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
            alert('è¯·é€‰æ‹©jpgã€pngæˆ–gifæ ¼å¼çš„å›¾ç‰‡ï¼');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const avatar = document.getElementById('editAvatar');
            avatar.innerHTML = '';
            avatar.style.fontSize = '0';
            avatar.style.background = '#fff';
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatar.appendChild(img);

            // ä¿å­˜æ–‡ä»¶å¯¹è±¡ï¼Œç¨åä¸Šä¼ 
            avatarFile = file;
        };
        reader.readAsDataURL(file);
    }
}

// å¡«å……ä¸ªäººèµ„æ–™åˆ°å¼¹çª—
function fillProfile() {
    if (!currentUser) return;

    document.getElementById('showUsername').innerText = currentUser.username;
    document.getElementById('showNickname').innerText = currentUser.nickname || currentUser.username;
    document.getElementById('showStudentId').innerText = currentUser.student_id;
    document.getElementById('showGender').innerText = currentUser.gender;
    document.getElementById('showCollege').innerText = currentUser.college;

    document.getElementById('editNickname').value = currentUser.nickname || currentUser.username;
    document.getElementById('editGender').value = currentUser.gender;
    document.getElementById('editCollege').value = currentUser.college;

    // å¤´åƒå›æ˜¾
    updateAvatarDisplay(currentUser.avatar);
}

// æ›´æ–°å¤´åƒæ˜¾ç¤º
function updateAvatarDisplay(avatarData) {
    const editAvatar = document.getElementById('editAvatar');
    const profileAvatar = document.getElementById('profileAvatar');

    // æ¸…ç©ºå¹¶è®¾ç½®é»˜è®¤
    [editAvatar, profileAvatar].forEach(avatar => {
        avatar.innerHTML = '';
        avatar.style.fontSize = '40px';
        avatar.style.background = '#f0f7ff';
        avatar.textContent = 'ğŸ‘¨';
    });

    if (avatarData) {
        [editAvatar, profileAvatar].forEach(avatar => {
            avatar.innerHTML = '';
            avatar.style.fontSize = '0';
            avatar.style.background = '#fff';
            const img = document.createElement('img');
            img.src = avatarData;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatar.appendChild(img);
        });
    }
}

// ä¿å­˜èµ„æ–™
async function saveProfile() {
    if (!currentUser) {
        alert('è¯·å…ˆç™»å½•ï¼');
        return;
    }

    const nickname = document.getElementById('editNickname').value.trim();
    const gender = document.getElementById('editGender').value;
    const college = document.getElementById('editCollege').value;

    if (!nickname) {
        alert('æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = document.querySelector('#m5 .submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'ä¿å­˜ä¸­...';
        submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('nickname', nickname);
        formData.append('gender', gender);
        formData.append('college', college);

        if (avatarFile) {
            formData.append('avatar', avatarFile);
        }

        const response = await fetch('/api/update-profile', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;

        if (data.success) {
            currentUser = data.user;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('showNickname').innerText = nickname;
            document.getElementById('showGender').innerText = gender;
            document.getElementById('showCollege').innerText = college;

            // æ›´æ–°å¤´åƒæ˜¾ç¤º
            if (data.user.avatar) {
                updateAvatarDisplay(data.user.avatar);
            }

            alert('èµ„æ–™ä¿å­˜æˆåŠŸï¼');
            document.getElementById('m5').style.display = 'none';
            document.getElementById('m4').style.display = 'flex';

            // é‡ç½®æ–‡ä»¶
            avatarFile = null;
        } else {
            alert(data.message || 'ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        console.error('ä¿å­˜èµ„æ–™é”™è¯¯:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = document.querySelector('#m5 .submit-btn');
        submitBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
        submitBtn.disabled = false;
    }
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤º/éšè—æ¨¡æ€æ¡†
function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
});
</script>
</body>
</html>