<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å…ƒé‚®èƒ¶å›Š</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', sans-serif;}
body{margin:0;height:100vh;position:relative;display:flex;flex-direction:column;overflow:hidden;background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);}
.bg{position:fixed;width:100%;height:100%;background:url(/static/bg.jpg) center/cover;opacity:0.7;filter:blur(3px) brightness(0.8);z-index:1;}
.btn-group{position:absolute;top:20px;right:20px;z-index:10;display:flex;border-radius:50px;overflow:hidden;box-shadow:0 8px 32px rgba(0, 0, 0, 0.2);backdrop-filter: blur(10px);background: rgba(255, 255, 255, 0.15);border: 1px solid rgba(255, 255, 255, 0.25);}
.btn{width:85px;height:85px;background:rgba(255,255,255,0.12);display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);position: relative;}
.btn:last-child{border-left:1px solid rgba(255, 255, 255, 0.2);}
.btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-5px) scale(1.05);box-shadow:0 10px 25px rgba(255, 255, 255, 0.3);}
.icon{font-size:32px;color:white;margin-bottom:5px;transition:all 0.4s;text-shadow: 0 2px 5px rgba(0,0,0,0.2);}
.icon-text{font-size:14px;color:white;font-weight:600;letter-spacing:0.5px;transition:all 0.4s;}
.btn:hover .icon{transform:scale(1.15) rotate(5deg);}
.btn:hover .icon-text{font-weight:700;letter-spacing:1px;}

/* é‚®ç®±å°çº¢ç‚¹ */
.mail-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #ff4757;
  color: white;
  font-size: 12px;
  font-weight: bold;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 6px;
  animation: pulse 2s infinite;
  box-shadow: 0 2px 10px rgba(255, 71, 87, 0.4);
  z-index: 11;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.title{text-align:center;margin:40px auto 0;z-index:10;position:relative;}
.main-title{font-size:68px;color:white;padding:25px 60px;border: 2px solid rgba(255, 255, 255, 0.4);border-radius:25px;background: rgba(255, 255, 255, 0.15);display:inline-block;letter-spacing:6px;box-shadow:0 15px 35px rgba(0, 0, 0, 0.3);backdrop-filter: blur(10px);font-weight:700;text-shadow: 0 2px 10px rgba(0,0,0,0.4);position: relative;overflow: hidden;}
.main-title::before{content: '';position: absolute;top: 0;left: -100%;width: 100%;height: 100%;background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation: shine 3s infinite;}
@keyframes shine { 100% { left: 100%; } }
.middle-box{flex:1;display:flex;z-index:10;padding:0 40px;gap:30px;margin:40px 0;align-items: center;justify-content: center;}
.middle-btn{width:320px;height:320px;display:flex;justify-content:center;align-items:center;border-radius:25px;box-shadow:0 20px 50px rgba(0, 0, 0, 0.4);font-size:42px;font-weight:800;cursor:pointer;transition:all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);text-decoration:none;position: relative;overflow: hidden;border: none;}
.middle-btn::before{content: '';position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: rgba(255, 255, 255, 0.15);border-radius: 25px;}
.middle-btn span{z-index: 2;position: relative;}
.left-btn{background:linear-gradient(135deg, rgba(106, 17, 203, 0.9) 0%, rgba(37, 117, 252, 0.9) 100%);color:white;}
.right-btn{background:linear-gradient(135deg, rgba(240, 147, 251, 0.9) 0%, rgba(245, 87, 108, 0.9) 100%);color:white;}
.middle-btn:hover{transform:translateY(-12px) scale(1.03);box-shadow:0 30px 60px rgba(0, 0, 0, 0.5);}
.middle-btn:hover::before{background: rgba(255, 255, 255, 0.2);}
.footer-box{height:100px;z-index:10;display:flex;padding:0 40px;gap:25px;align-items:center;justify-content:center;margin-bottom:30px;}
.footer-btn{width:240px;height:60px;background:rgba(255,255,255,0.15);border-radius:15px;display:flex;justify-content:center;align-items:center;font-size:18px;color:white;font-weight:600;cursor:pointer;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, 0.25);position: relative;overflow: hidden;}
.footer-btn::before{content: '';position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: rgba(255, 255, 255, 0.1);border-radius: 15px;}
.footer-btn span{z-index: 2;position: relative;}
.footer-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-8px) scale(1.05);color:#fff;box-shadow:0 15px 30px rgba(0, 0, 0, 0.4);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:999;backdrop-filter: blur(5px);}
.modal-box{width:520px;background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(240, 245, 255, 0.98));padding:35px;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,0.3);border: 1px solid rgba(255, 255, 255, 0.3);position: relative;overflow: hidden;max-height: 80vh;overflow-y: auto;}
.modal-box::before{content: '';position: absolute;top: 0;left: 0;right: 0;height: 5px;background: linear-gradient(90deg, #6a11cb, #2575fc);}
.close-btn{position:absolute;right:20px;top:20px;cursor:pointer;color:#999;font-size:28px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s;z-index: 2;}
.close-btn:hover{color:#333;background:rgba(0,0,0,0.05);transform: rotate(90deg);}
.modal-title{font-size:24px;color:#2c3e50;margin-bottom:25px;text-align:center;font-weight:700;padding-bottom:20px;border-bottom:2px solid #f0f5ff;position: relative;}
.modal-title::after{content: '';position: absolute;bottom: -2px;left: 50%;transform: translateX(-50%);width: 60px;height: 3px;background: linear-gradient(90deg, #6a11cb, #2575fc);border-radius: 3px;}
.modal-txt{font-size:16px;color:#555;line-height:1.7;}

/* é‚®ç®±é€šçŸ¥æ ·å¼ */
.notification-list {
  max-height: 400px;
  overflow-y: auto;
  margin-top: 15px;
}

.notification-item {
  padding: 15px;
  border-bottom: 1px solid #f0f0f0;
  transition: all 0.3s;
}

.notification-item:hover {
  background: #f9f9f9;
}

.notification-header {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}

.notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  margin-right: 12px;
  flex-shrink: 0;
}

.notification-title {
  font-size: 15px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 3px;
}

.notification-time {
  font-size: 12px;
  color: #999;
}

.notification-content {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-top: 8px;
  padding-left: 48px;
}

.no-notifications {
  text-align: center;
  padding: 40px 20px;
  color: #999;
  font-size: 16px;
}

.clear-notifications {
  display: block;
  width: 100%;
  padding: 10px;
  background: #f8f9fa;
  color: #666;
  border: none;
  border-radius: 8px;
  margin-top: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.clear-notifications:hover {
  background: #e9ecef;
  color: #333;
}

.form-item{margin:18px 0;}
.form-item label{display:block;font-size:14px;color:#555;margin-bottom:8px;font-weight:600;}
.form-item input{width:100%;height:48px;padding:0 18px;border:2px solid #e0e8f5;border-radius:12px;font-size:15px;transition:all 0.3s;background: rgba(255,255,255,0.9);}
.form-item input:focus{outline:none;border-color:#6a11cb;box-shadow:0 0 0 4px rgba(106, 17, 203, 0.1);}
.submit-btn{width:100%;height:50px;background:linear-gradient(90deg, #6a11cb, #2575fc);color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;margin-top:15px;transition:all 0.4s;position: relative;overflow: hidden;}
.submit-btn:hover{transform: translateY(-3px);box-shadow:0 10px 20px rgba(106, 17, 203, 0.3);}
.submit-btn:active{transform: translateY(-1px);}
.reg-txt{text-align:center;margin-top:20px;font-size:14px;color:#777;}
.reg-btn{color:#6a11cb;cursor:pointer;margin-left:5px;font-weight:600;transition: all 0.3s;}
.reg-btn:hover{text-decoration:underline;color:#2575fc;}
.profile-header{text-align:center;margin-bottom:30px;}
.profile-avatar{width:100px;height:100px;border-radius:50%;margin:0 auto 15px;display:flex;justify-content:center;align-items:center;font-size:48px;background:linear-gradient(135deg, #6a11cb, #2575fc);color:white;object-fit:cover;box-shadow: 0 10px 20px rgba(106, 17, 203, 0.2);border: 3px solid white;}
.profile-info{margin:18px 0;font-size:16px;color:#333;display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f5ff;}
.info-label{color:#666;font-weight:600;}
.edit-btn{font-size:15px;background:linear-gradient(90deg, #6a11cb, #2575fc);-webkit-background-clip:text;background-clip:text;color:transparent;cursor:pointer;font-weight:700;padding: 6px 16px;border-radius: 8px;border: 2px solid #e0e8f5;transition: all 0.3s;}
.edit-btn:hover{border-color: #6a11cb;background: linear-gradient(90deg, #6a11cb, #2575fc);color: white;}
.gender-select, .college-select{width:100%;height:48px;padding:0 15px;border:2px solid #e0e8f5;border-radius:12px;font-size:15px;color:#333;background: rgba(255,255,255,0.9);transition: all 0.3s;}
.gender-select:focus, .college-select:focus{outline:none;border-color:#6a11cb;box-shadow:0 0 0 4px rgba(106, 17, 203, 0.1);}
.avatar-upload{margin-top:15px;}
.upload-btn{font-size:15px;background:linear-gradient(90deg, #6a11cb, #2575fc);-webkit-background-clip:text;background-clip:text;color:transparent;cursor:pointer;font-weight:700;padding: 8px 20px;border-radius: 8px;border: 2px solid #e0e8f5;transition: all 0.3s;display: inline-block;}
.upload-btn:hover{border-color: #6a11cb;background: linear-gradient(90deg, #6a11cb, #2575fc);color: white;}
#avatarInput{display:none;}
.login-status{position:absolute;top:20px;left:20px;z-index:10;padding:10px 20px;background:rgba(255,255,255,0.15);border-radius:50px;color:white;font-size:14px;font-weight:600;backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, 0.25);box-shadow:0 5px 15px rgba(0,0,0,0.2);display: none;}
.login-status.show{display: block;}
</style>
</head>
<body>
<div class="bg"></div>
<!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
<div class="login-status" id="loginStatus">
  æ¬¢è¿ï¼Œ<span id="userName">ç”¨æˆ·</span> |
  <span style="color:#ffdd40;cursor:pointer;margin-left:5px;" onclick="logout()">é€€å‡º</span>
</div>

<div class="btn-group">
  <div class="btn" onclick="showMailModal()">
    <div class="icon">âœ‰ï¸</div>
    <div class="icon-text">é‚®ç®±</div>
    <div class="mail-badge" id="mailBadge" style="display: none;">0</div>
  </div>
  <div class="btn" onclick="showLoginOrProfile()" id="loginBtn">
    <div class="icon">ğŸ‘¤</div>
    <div class="icon-text" id="loginBtnText">ç™»å½•</div>
  </div>
</div>

<div class="title">
  <h1 class="main-title">å…ƒé‚®èƒ¶å›Š</h1>
</div>

<div class="middle-box">
  <a href="{{ url_for('campus') }}" class="middle-btn left-btn">
    <span>Explore</span>
  </a>
  <div class="middle-btn right-btn" onclick="openMyBUPT()">
    <span>My BUPT</span>
  </div>
</div>

<div class="footer-box">
  <div class="footer-btn" onclick="checkLoginThenShowProfile()">
    <span>ä¸ªäººèµ„æ–™</span>
  </div>
  <div class="footer-btn" onclick="showAbout()">
    <span>å…³äºæˆ‘ä»¬</span>
  </div>
</div>

<!-- é‚®ç®±æ¶ˆæ¯å¼¹çª— -->
<div class="modal" id="m1">
  <div class="modal-box">
    <span class="close-btn" onclick="closeModal('m1')">Ã—</span>
    <h3 class="modal-title">æˆ‘çš„æ¶ˆæ¯</h3>
    <div class="notification-list" id="notificationList">
      <!-- é€šçŸ¥å†…å®¹ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
    </div>
    <button class="clear-notifications" onclick="clearAllNotifications()">æ¸…ç©ºæ‰€æœ‰é€šçŸ¥</button>
  </div>
</div>

<!-- ç™»å½•å¼¹çª— -->
<div class="modal" id="m2">
  <div class="modal-box">
    <span class="close-btn" onclick="closeModal('m2')">Ã—</span>
    <h3 class="modal-title">è´¦å·ç™»å½•</h3>
    <div class="form-item">
      <label>ç”¨æˆ·åæˆ–å­¦å·</label>
      <input type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–å­¦å·" id="loginUsername">
    </div>
    <div class="form-item">
      <label>å¯†ç </label>
      <input type="password" placeholder="è¯·è¾“å…¥å¯†ç " id="loginPassword">
    </div>
    <button class="submit-btn" onclick="saveLoginInfo()">ç™»å½•</button>
    <div class="reg-txt">æœªæ³¨å†Œï¼Ÿ<span class="reg-btn" onclick="showRegister()">ç«‹å³æ³¨å†Œ</span></div>
  </div>
</div>

<!-- æ³¨å†Œå¼¹çª— -->
<div class="modal" id="m3">
  <div class="modal-box">
    <span class="close-btn" onclick="closeModal('m3')">Ã—</span>
    <h3 class="modal-title">è´¦å·æ³¨å†Œ</h3>
    <div class="form-item">
      <label>ç”¨æˆ·å</label>
      <input type="text" placeholder="è¯·è®¾ç½®ç”¨æˆ·åï¼ˆè‡³å°‘3ä½ï¼‰" id="regUsername">
    </div>
    <div class="form-item">
      <label>å¯†ç </label>
      <input type="password" placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" id="regPassword">
    </div>
    <div class="form-item">
      <label>å­¦å·</label>
      <input type="text" placeholder="è¯·è¾“å…¥å­¦å·" id="regStudentId">
    </div>
    <button class="submit-btn" onclick="saveRegInfo()">å®Œæˆæ³¨å†Œ</button>
  </div>
</div>

<!-- ä¸ªäººèµ„æ–™æŸ¥çœ‹å¼¹çª— -->
<div class="modal" id="m4">
  <div class="modal-box">
    <span class="close-btn" onclick="closeModal('m4')">Ã—</span>
    <h3 class="modal-title">ä¸ªäººèµ„æ–™</h3>
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar">ğŸ‘¨</div>
    </div>
    <div class="profile-info">
      <span class="info-label">ç”¨æˆ·å</span>
      <span id="showUsername">æœªç™»å½•</span>
    </div>
    <div class="profile-info">
      <span class="info-label">æ˜µç§°</span>
      <span id="showNickname">æœªè®¾ç½®</span>
    </div>
    <div class="profile-info">
      <span class="info-label">å­¦å·</span>
      <span id="showStudentId">æœªè®¾ç½®</span>
    </div>
    <div class="profile-info">
      <span class="info-label">æ€§åˆ«</span>
      <span id="showGender">æœªè®¾ç½®</span>
    </div>
    <div class="profile-info">
      <span class="info-label">å­¦é™¢</span>
      <span id="showCollege">æœªè®¾ç½®</span>
    </div>
    <div style="text-align:right;margin-top:25px;">
      <span class="edit-btn" onclick="showEditProfile()">ç¼–è¾‘èµ„æ–™</span>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
<div class="modal" id="m5">
  <div class="modal-box">
    <span class="close-btn" onclick="closeModal('m5')">Ã—</span>
    <h3 class="modal-title">ç¼–è¾‘èµ„æ–™</h3>
    <div class="profile-header">
      <div class="profile-avatar" id="editAvatar">ğŸ‘¨</div>
      <div class="avatar-upload">
        <span class="upload-btn" onclick="document.getElementById('avatarInput').click()">é€‰æ‹©æœ¬åœ°å¤´åƒ</span>
        <input type="file" id="avatarInput" accept="image/*" onchange="previewAvatar(this)">
      </div>
    </div>
    <div class="form-item">
      <label>æ˜µç§°</label>
      <input type="text" placeholder="è¯·è¾“å…¥æ˜µç§°" id="editNickname">
    </div>
    <div class="form-item">
      <label>æ€§åˆ«</label>
      <select class="gender-select" id="editGender">
        <option value="æœªè®¾ç½®">è¯·é€‰æ‹©æ€§åˆ«</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
      </select>
    </div>
    <div class="form-item">
      <label>å­¦é™¢</label>
      <select class="college-select" id="editCollege">
        <option value="æœªè®¾ç½®">è¯·é€‰æ‹©å­¦é™¢</option>
        <option value="æ•°å­—åª’ä½“ä¸è‰ºæœ¯è®¾è®¡å­¦é™¢">æ•°å­—åª’ä½“ä¸è‰ºæœ¯è®¾è®¡å­¦é™¢</option>
        <option value="ä¿¡æ¯ä¸é€šä¿¡å·¥ç¨‹å­¦é™¢">ä¿¡æ¯ä¸é€šä¿¡å·¥ç¨‹å­¦é™¢</option>
        <option value="ç”µå­å·¥ç¨‹å­¦é™¢">ç”µå­å·¥ç¨‹å­¦é™¢</option>
        <option value="è®¡ç®—æœºå­¦é™¢">è®¡ç®—æœºå­¦é™¢</option>
        <option value="ç½‘ç»œç©ºé—´å®‰å…¨å­¦é™¢">ç½‘ç»œç©ºé—´å®‰å…¨å­¦é™¢</option>
        <option value="æ™ºèƒ½å·¥ç¨‹ä¸è‡ªåŠ¨åŒ–å­¦é™¢">æ™ºèƒ½å·¥ç¨‹ä¸è‡ªåŠ¨åŒ–å­¦é™¢</option>
      </select>
    </div>
    <button class="submit-btn" onclick="saveProfile()">ä¿å­˜ä¿®æ”¹</button>
  </div>
</div>

<!-- å…³äºæˆ‘ä»¬å¼¹çª— -->
<div class="modal" id="m6">
  <div class="modal-box">
    <span class="close-btn" onclick="closeModal('m6')">Ã—</span>
    <h3 class="modal-title">å…³äºæˆ‘ä»¬</h3>
    <div class="modal-txt" style="text-align: center;">
      <p style="font-size: 20px; color: #6a11cb; margin-bottom: 15px;">ğŸ“ å…ƒé‚®èƒ¶å›Š</p>
      <p>åŒ—äº¬é‚®ç”µå¤§å­¦æ ¡å›­è®°å¿†æ•°å­—ç©ºé—´</p>
      <p>è®°å½•ç¾å¥½æ ¡å›­æ—¶å…‰</p>
      <p>çè—æ¯ä¸€ä»½é’æ˜¥è®°å¿†</p>
      <p>ç ”å‘å›¢é˜Ÿ</p>
      <p>2025çº§</p>
      <p>è®¡ç®—æœºå­¦é™¢ è‘£èŠ¯å½¤</p>
      <p>ç”µå­å·¥ç¨‹å­¦é™¢ å®—æ•¬ä¼¦</p>
      <p>ç”µå­å·¥ç¨‹å­¦é™¢ ç‹ä½³æ¯…</p>
      <p>ç”µå­å·¥ç¨‹å­¦é™¢ åˆ˜å˜‰ä¼¦</p>
      <p>é›†æˆç”µè·¯å­¦é™¢ æ¯•ä¼¦</p>
      <p style="margin-top: 20px; color: #777; font-size: 14px;">Â© 2026 å…ƒé‚®èƒ¶å›Š ç‰ˆæƒæ‰€æœ‰</p>
    </div>
  </div>
</div>

<script>
// APIåŸºç¡€URL
const API_BASE = '/api';
let currentUser = null;
let avatarFile = null;

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæ›´æ–°é‚®ç®±é€šçŸ¥
window.onload = async function() {
  await checkLoginStatus();
  updateMailBadge();
  setupModalEvents();
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€
async function checkLoginStatus() {
  try {
    const response = await fetch(`${API_BASE}/check-login`);
    const data = await response.json();

    if (data.logged_in && data.user) {
      currentUser = data.user;
      updateLoginStatus();
    }
  } catch (error) {
    console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
  }
}

// é€šç”¨å…³é—­å¼¹çª—å‡½æ•°
function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// è®¾ç½®å¼¹çª—äº‹ä»¶
function setupModalEvents() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.onclick = function(e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    };
  });

  // ESCé”®å…³é—­å¼¹çª—
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (modal.style.display === 'flex') {
          modal.style.display = 'none';
        }
      });
    }
  });
}

// æ˜¾ç¤ºé‚®ç®±å¼¹çª—
function showMailModal() {
  loadNotifications();
  document.getElementById('m1').style.display = 'flex';
}

// åŠ è½½é€šçŸ¥
function loadNotifications() {
  // æš‚æ—¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„é€šçŸ¥
  const notifications = JSON.parse(localStorage.getItem('mailNotifications')) || [];
  const notificationList = document.getElementById('notificationList');

  if (notifications.length === 0) {
    notificationList.innerHTML = '<div class="no-notifications">ğŸ“­ æš‚æ— æ–°æ¶ˆæ¯</div>';
    return;
  }

  const notificationsHTML = notifications.map(notification => {
    let icon = 'ğŸ’¬';
    let title = '';

    if (notification.type === 'like') {
      icon = 'â¤ï¸';
      title = `${notification.fromUser} ç‚¹èµäº†ä½ çš„å›å¿†`;
    } else if (notification.type === 'reply') {
      icon = 'ğŸ’¬';
      title = `${notification.fromUser} å›å¤äº†ä½ çš„å›å¿†`;
    }

    return `
    <div class="notification-item">
      <div class="notification-header">
        <div class="notification-icon">${icon}</div>
        <div>
          <div class="notification-title">${title}</div>
          <div class="notification-time">${notification.time}</div>
        </div>
      </div>
      <div class="notification-content">
        ${notification.content}
        <div style="font-size:12px;color:#999;margin-top:5px;">
          åœ°ç‚¹ï¼š${notification.scene}
        </div>
      </div>
    </div>`;
  }).join('');

  notificationList.innerHTML = notificationsHTML;
}

// æ¸…ç©ºæ‰€æœ‰é€šçŸ¥
function clearAllNotifications() {
  localStorage.removeItem('mailNotifications');
  loadNotifications();
  updateMailBadge();
  showSuccess('å·²æ¸…ç©ºæ‰€æœ‰é€šçŸ¥');
}

// æ›´æ–°é‚®ç®±å°çº¢ç‚¹
function updateMailBadge() {
  const notifications = JSON.parse(localStorage.getItem('mailNotifications')) || [];
  const mailBadge = document.getElementById('mailBadge');

  if (notifications.length > 0) {
    mailBadge.style.display = 'flex';
    mailBadge.textContent = notifications.length > 99 ? '99+' : notifications.length;
  } else {
    mailBadge.style.display = 'none';
  }
}

// æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º
function updateLoginStatus() {
  const loginStatus = document.getElementById('loginStatus');
  const loginBtnText = document.getElementById('loginBtnText');
  const userName = document.getElementById('userName');

  if (currentUser) {
    loginStatus.classList.add('show');
    userName.textContent = currentUser.nickname || currentUser.username;
    loginBtnText.textContent = 'å·²ç™»å½•';
  } else {
    loginStatus.classList.remove('show');
    loginBtnText.textContent = 'ç™»å½•';
  }
}

// æ˜¾ç¤ºç™»å½•æˆ–èµ„æ–™
function showLoginOrProfile() {
  if (currentUser) {
    checkLoginThenShowProfile();
  } else {
    document.getElementById('m2').style.display = 'flex';
  }
}

// æ˜¾ç¤ºæ³¨å†Œå¼¹çª—
function showRegister() {
  closeModal('m2');
  setTimeout(() => {
    document.getElementById('m3').style.display = 'flex';
  }, 200);
}

// æ£€æŸ¥ç™»å½•åæ˜¾ç¤ºä¸ªäººèµ„æ–™
async function checkLoginThenShowProfile() {
  try {
    const response = await fetch(`${API_BASE}/check-login`);
    const data = await response.json();

    if (data.logged_in && data.user) {
      currentUser = data.user;
      fillProfile();
      document.getElementById('m4').style.display = 'flex';
    } else {
      alert('è¯·å…ˆç™»å½•ï¼Œæ‰èƒ½æŸ¥çœ‹ä¸ªäººèµ„æ–™ï½');
      document.getElementById('m2').style.display = 'flex';
    }
  } catch (error) {
    console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
    alert('è¯·å…ˆç™»å½•ï¼Œæ‰èƒ½æŸ¥çœ‹ä¸ªäººèµ„æ–™ï½');
    document.getElementById('m2').style.display = 'flex';
  }
}

// æ‰“å¼€My BUPTé¡µé¢
function openMyBUPT() {
  if (!currentUser) {
    alert('è¯·å…ˆç™»å½•ï¼Œæ‰èƒ½è®¿é—®My BUPTï½');
    document.getElementById('m2').style.display = 'flex';
    return;
  }
  // è·³è½¬åˆ°My BUPTé¡µé¢ï¼ˆéœ€è¦åˆ›å»ºmy-bupt.htmlï¼‰
  window.location.href = '/my-bupt';
}

// æ˜¾ç¤ºç¼–è¾‘èµ„æ–™å¼¹çª—
function showEditProfile() {
  closeModal('m4');
  setTimeout(() => {
    document.getElementById('m5').style.display = 'flex';
  }, 200);
}

// æ˜¾ç¤ºå…³äºæˆ‘ä»¬
function showAbout() {
  document.getElementById('m6').style.display = 'flex';
}

// ç™»å½•éªŒè¯ - è¿æ¥åˆ°åç«¯
async function saveLoginInfo() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  if (!username || !password) {
    showError('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼');
    return;
  }

  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.querySelector('#m2 .submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'ç™»å½•ä¸­...';
    submitBtn.disabled = true;

    const response = await fetch(`${API_BASE}/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        password: password
      })
    });

    const data = await response.json();

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;

    if (data.success) {
      currentUser = data.user;
      updateLoginStatus();
      updateMailBadge();

      // æ¸…ç©ºè¡¨å•
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';

      closeModal('m2');
      showSuccess('ç™»å½•æˆåŠŸï¼');
    } else {
      showError(data.message || 'ç™»å½•å¤±è´¥ï¼');
    }
  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    const submitBtn = document.querySelector('#m2 .submit-btn');
    submitBtn.textContent = 'ç™»å½•';
    submitBtn.disabled = false;
  }
}

// æ³¨å†ŒåŠŸèƒ½ - è¿æ¥åˆ°åç«¯
async function saveRegInfo() {
  const username = document.getElementById('regUsername').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const studentId = document.getElementById('regStudentId').value.trim();

  if (!username || !password || !studentId) {
    showError('æ‰€æœ‰å­—æ®µéƒ½ä¸èƒ½ä¸ºç©ºï¼');
    return;
  }

  if (username.length < 3) {
    showError('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦ï¼');
    return;
  }

  if (password.length < 6) {
    showError('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦ï¼');
    return;
  }

  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.querySelector('#m3 .submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'æ³¨å†Œä¸­...';
    submitBtn.disabled = true;

    const response = await fetch(`${API_BASE}/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        password: password,
        student_id: studentId
      })
    });

    const data = await response.json();

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;

    if (data.success) {
      currentUser = data.user;

      // æ¸…ç©ºè¡¨å•
      document.getElementById('regUsername').value = '';
      document.getElementById('regPassword').value = '';
      document.getElementById('regStudentId').value = '';

      closeModal('m3');
      document.getElementById('m2').style.display = 'flex';
      showSuccess('æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•ï½');
    } else {
      showError(data.message || 'æ³¨å†Œå¤±è´¥ï¼');
    }
  } catch (error) {
    console.error('æ³¨å†Œé”™è¯¯:', error);
    showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    const submitBtn = document.querySelector('#m3 .submit-btn');
    submitBtn.textContent = 'å®Œæˆæ³¨å†Œ';
    submitBtn.disabled = false;
  }
}

// å¤´åƒé¢„è§ˆ
function previewAvatar(input) {
  const file = input.files[0];
  if (!file) return;

  // æ£€æŸ¥æ–‡ä»¶ç±»å‹
  if (!file.type.startsWith('image/')) {
    showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
    return;
  }

  // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
  if (file.size > 2 * 1024 * 1024) {
    showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MBï¼');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const avatar = document.getElementById('editAvatar');
    avatar.innerHTML = '';
    avatar.style.fontSize = '0';
    avatar.style.background = '#fff';
    const img = document.createElement('img');
    img.src = e.target.result;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.borderRadius = '50%';
    img.style.objectFit = 'cover';
    avatar.appendChild(img);

    // ä¿å­˜æ–‡ä»¶å¯¹è±¡ï¼Œç¨åä¸Šä¼ 
    avatarFile = file;
  }
  reader.readAsDataURL(file);
}

// å¡«å……ä¸ªäººèµ„æ–™
function fillProfile() {
  if (!currentUser) return;

  document.getElementById('showUsername').innerText = currentUser.username;
  document.getElementById('showNickname').innerText = currentUser.nickname || currentUser.username;
  document.getElementById('showStudentId').innerText = currentUser.student_id;
  document.getElementById('showGender').innerText = currentUser.gender;
  document.getElementById('showCollege').innerText = currentUser.college;

  document.getElementById('editNickname').value = currentUser.nickname || currentUser.username;
  document.getElementById('editGender').value = currentUser.gender;
  document.getElementById('editCollege').value = currentUser.college;

  // å¤´åƒå›æ˜¾
  updateAvatarDisplay();
}

// æ›´æ–°å¤´åƒæ˜¾ç¤º
function updateAvatarDisplay() {
  const editAvatar = document.getElementById('editAvatar');
  const profileAvatar = document.getElementById('profileAvatar');

  // æ¸…ç©ºå¹¶è®¾ç½®é»˜è®¤
  [editAvatar, profileAvatar].forEach(avatar => {
    avatar.innerHTML = '';
    avatar.style.fontSize = '48px';
    avatar.style.background = 'linear-gradient(135deg, #6a11cb, #2575fc)';
    avatar.style.color = 'white';
    avatar.style.display = 'flex';
    avatar.style.justifyContent = 'center';
    avatar.style.alignItems = 'center';
    avatar.textContent = 'ğŸ‘¨';
  });

  if (currentUser && currentUser.avatar) {
    [editAvatar, profileAvatar].forEach(avatar => {
      avatar.innerHTML = '';
      avatar.style.fontSize = '0';
      avatar.style.background = '#fff';
      const img = document.createElement('img');
      img.src = currentUser.avatar;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.borderRadius = '50%';
      img.style.objectFit = 'cover';
      avatar.appendChild(img);
    });
  }
}

// ä¿å­˜ä¸ªäººèµ„æ–™ - è¿æ¥åˆ°åç«¯
async function saveProfile() {
  if (!currentUser) {
    showError('è¯·å…ˆç™»å½•ï¼');
    return;
  }

  const nickname = document.getElementById('editNickname').value.trim();
  const gender = document.getElementById('editGender').value;
  const college = document.getElementById('editCollege').value;

  if (!nickname) {
    showError('æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼');
    return;
  }

  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.querySelector('#m5 .submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'ä¿å­˜ä¸­...';
    submitBtn.disabled = true;

    const formData = new FormData();
    formData.append('nickname', nickname);
    formData.append('gender', gender);
    formData.append('college', college);

    if (avatarFile) {
      formData.append('avatar', avatarFile);
    }

    const response = await fetch(`${API_BASE}/update-profile`, {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;

    if (data.success) {
      currentUser = data.user;

      // æ›´æ–°æ˜¾ç¤º
      document.getElementById('showNickname').innerText = nickname;
      document.getElementById('showGender').innerText = gender;
      document.getElementById('showCollege').innerText = college;

      // æ›´æ–°å¤´åƒæ˜¾ç¤º
      if (data.user.avatar) {
        updateAvatarDisplay();
      }

      closeModal('m5');
      document.getElementById('m4').style.display = 'flex';
      updateLoginStatus();
      showSuccess('èµ„æ–™ä¿å­˜æˆåŠŸï¼');

      // é‡ç½®æ–‡ä»¶
      avatarFile = null;
    } else {
      showError(data.message || 'ä¿å­˜å¤±è´¥');
    }
  } catch (error) {
    console.error('ä¿å­˜èµ„æ–™é”™è¯¯:', error);
    showError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    const submitBtn = document.querySelector('#m5 .submit-btn');
    submitBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
    submitBtn.disabled = false;
  }
}

// é€€å‡ºç™»å½•
async function logout() {
  if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
    return;
  }

  try {
    await fetch(`${API_BASE}/logout`, {
      method: 'POST'
    });

    currentUser = null;
    updateLoginStatus();
    updateMailBadge();
    showSuccess('å·²é€€å‡ºç™»å½•');
  } catch (error) {
    console.error('ç™»å‡ºé”™è¯¯:', error);
    showError('é€€å‡ºç™»å½•å¤±è´¥');
  }
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccess(message) {
  showAlert(message, 'success');
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showError(message) {
  showAlert(message, 'error');
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showAlert(message, type) {
  const colors = {
    success: 'linear-gradient(90deg, #4CAF50, #45a049)',
    error: 'linear-gradient(90deg, #f44336, #d32f2f)'
  };

  const alertDiv = document.createElement('div');
  alertDiv.textContent = message;
  alertDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${colors[type] || colors.success};
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    z-index: 1000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    font-weight: 600;
    animation: slideIn 0.3s ease;
  `;
  document.body.appendChild(alertDiv);

  setTimeout(() => {
    alertDiv.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => alertDiv.remove(), 300);
  }, 2000);

  // æ·»åŠ åŠ¨ç”»æ ·å¼
  if (!document.getElementById('alertAnimations')) {
    const style = document.createElement('style');
    style.id = 'alertAnimations';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
}
</script>
</body>
</html>